name: CI - Security Checklist

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite execu√ß√£o manual

jobs:
  lint:
    name: üîç Lint & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêö Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: üîç Run ShellCheck
        run: |
          shellcheck --severity=warning --exclude=SC2155,SC2129,SC2126,SC2001 security_checklist.sh
          shellcheck --severity=warning --exclude=SC2155,SC2129,SC2126,SC2001,SC2034,SC2178,SC2128 service_optimizer.sh

      - name: ‚úÖ Check script is executable
        run: |
          if [[ -x "security_checklist.sh" ]] || head -1 security_checklist.sh | grep -q "^#!/bin/bash"; then
            echo "‚úÖ Script has proper shebang"
          else
            echo "‚ùå Script missing shebang or not executable"
            exit 1
          fi

  test:
    name: üß™ Test Script
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Make script executable
        run: |
          chmod +x security_checklist.sh
          chmod +x service_optimizer.sh

      - name: üìã Test help option
        run: |
          ./security_checklist.sh --help
          ./service_optimizer.sh --help

      - name: üñ•Ô∏è Test terminal output (dry run)
        run: |
          # Executar com timeout para evitar travamentos
          timeout 60 ./security_checklist.sh || true
        continue-on-error: true

      - name: ÔøΩ Test service optimizer (list only)
        run: |
          ./service_optimizer.sh --list -t desktop
          ./service_optimizer.sh --list -t server
          ./service_optimizer.sh --list -t container
        continue-on-error: true

      - name: ÔøΩüìÑ Test HTML export
        run: |
          ./security_checklist.sh -f html -o test_report.html || true
          if [ -f "test_report.html" ]; then
            echo "‚úÖ HTML report generated successfully"
            head -20 test_report.html
          else
            echo "‚ö†Ô∏è HTML report not generated (may require sudo)"
          fi
        continue-on-error: true

      - name: üìä Test CSV export
        run: |
          ./security_checklist.sh -f csv -o test_report.csv || true
          if [ -f "test_report.csv" ]; then
            echo "‚úÖ CSV report generated successfully"
            cat test_report.csv
          else
            echo "‚ö†Ô∏è CSV report not generated (may require sudo)"
          fi
        continue-on-error: true

      - name: üì§ Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            test_report.html
            test_report.csv
          retention-days: 7
          if-no-files-found: ignore

  release:
    name: üöÄ Create Release
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[release]')
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üè∑Ô∏è Get version
        id: version
        run: |
          VERSION=$(grep -o 'Vers√£o: [0-9.]*' security_checklist.sh | head -1 | cut -d' ' -f2)
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Version: $VERSION"

      - name: üì¶ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## üõ°Ô∏è Security Checklist v${{ steps.version.outputs.version }}
            
            ### Instala√ß√£o
            ```bash
            wget https://github.com/${{ github.repository }}/raw/main/security_checklist.sh
            chmod +x security_checklist.sh
            sudo ./security_checklist.sh
            ```
            
            ### Formatos de sa√≠da
            - Terminal (padr√£o)
            - HTML: `sudo ./security_checklist.sh -f html`
            - CSV: `sudo ./security_checklist.sh -f csv`
          files: security_checklist.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
